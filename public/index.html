<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Admin - PontoSaaS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; }
        .sidebar { width: 250px; background: #0f172a; color: white; height: 100vh; padding: 20px; }
        .content { flex: 1; padding: 40px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
        .btn-add { background: var(--primary); color: white; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 400px; }
    </style>
</head>
<body>
    <div class="sidebar"><h2>PontoSaaS</h2></div>
    <div class="content">
        <div style="display:flex; justify-content: space-between;">
            <h1>Empresas Clientes</h1>
            <button class="btn btn-add" onclick="document.getElementById('mEmpresa').style.display='flex'">+ Nova Empresa</button>
        </div>
        <div class="card">
            <table>
                <thead><tr><th>Empresa</th><th>Status</th><th>Ações</th></tr></thead>
                <tbody id="lista"></tbody>
            </table>
        </div>
    </div>

    <div id="mEmpresa" class="modal">
        <div class="modal-content">
            <h3>Novo Cadastro</h3>
            <input type="text" id="n_nome" placeholder="Nome Fantasia" style="width:100%; margin-bottom:10px; padding:8px;">
            <input type="text" id="n_cnpj" placeholder="CNPJ" style="width:100%; margin-bottom:10px; padding:8px;">
            <button class="btn btn-add" onclick="salvar()">Salvar</button>
            <button onclick="document.getElementById('mEmpresa').style.display='none'">Cancelar</button>
        </div>
    </div>

    <div id="mQR" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3>Ativação do Tablet</h3>
            <div id="qrcode" style="margin:20px auto; display:inline-block;"></div>
            <br><button onclick="document.getElementById('mQR').style.display='none'">Fechar</button>
        </div>
    </div>

    <script>
        const API = "https://pontoback-tau.vercel.app/api";

        async function carregar() {
            const res = await fetch(`${API}/clientes`);
            const dados = await res.json();
            const corpo = document.getElementById('lista');
            corpo.innerHTML = dados.map(e => `
                <tr>
                    <td>${e.nome_fantasia}<br><small>${e.cnpj}</small></td>
                    <td>${e.status}</td>
                    <td>
                        <button onclick="gerarQR('${e.id}', '${e.nome_fantasia}')"><i class="fas fa-qrcode"></i></button>
                        <button onclick="alterarStatus('${e.id}', '${e.status}')"><i class="fas fa-ban"></i></button>
                        <button onclick="window.open('${API}/clientes/${e.id}/afd')"><i class="fas fa-file-download"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function salvar() {
            await fetch(`${API}/clientes`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({nome: document.getElementById('n_nome').value, cnpj: document.getElementById('n_cnpj').value})
            });
            location.reload();
        }

        async function alterarStatus(id, atual) {
            const novo = atual === 'ativo' ? 'inadimplente' : 'ativo';
            await fetch(`${API}/clientes/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status: novo})
            });
            carregar();
        }

        function gerarQR(id, nome) {
            document.getElementById('qrcode').innerHTML = "";
            const config = btoa(JSON.stringify({id, nome, api: API}));
            new QRCode(document.getElementById('qrcode'), { text: config, width: 200, height: 200 });
            document.getElementById('mQR').style.display = 'flex';
        }

        carregar();
    </script>
</body>
</html>
