<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Sistema de Ponto SaaS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca; --secondary: #64748b;
            --success: #22c55e; --danger: #ef4444; --bg: #f8fafc;
            --sidebar: #0f172a; --card: #ffffff; --text-main: #1e293b; --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); }

        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--sidebar); color: white; padding: 1.5rem; flex-shrink: 0; }
        .sidebar-header { margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
        .sidebar-header i { font-size: 1.5rem; color: var(--primary); }
        
        .main-content { flex-grow: 1; padding: 2rem; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        
        .btn-add { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .card-container { background: var(--card); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 16px; text-align: left; font-size: 0.85rem; color: var(--secondary); }
        td { padding: 16px; border-bottom: 1px solid var(--border); }

        .status-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-blocked { background: #fee2e2; color: #991b1b; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 450px; border-radius: 16px; padding: 2rem; }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; }
    </style>
</head>
<body>

<div class="dashboard-container">
    <aside class="sidebar">
        <div class="sidebar-header"><i class="fas fa-clock"></i> <h2>Ponto<strong>SaaS</strong></h2></div>
    </aside>

    <main class="main-content">
        <header>
            <h1>Empresas Clientes</h1>
            <button class="btn-add" onclick="openModal('modalEmpresa')">+ Cadastrar Empresa</button>
        </header>

        <div class="card-container">
            <table>
                <thead>
                    <tr>
                        <th>Nome / CNPJ</th>
                        <th>Plano</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-clientes">
                    </tbody>
            </table>
        </div>
    </main>
</div>

<div id="modalEmpresa" class="modal">
    <div class="modal-content">
        <h3>Nova Empresa</h3><br>
        <form id="formCliente">
            <div class="form-group"><label>Nome Fantasia</label><input type="text" id="nome" required></div>
            <div class="form-group"><label>CNPJ</label><input type="text" id="cnpj" required></div>
            <button type="submit" class="btn-add" style="width: 100%;">Salvar Empresa</button>
            <button type="button" onclick="closeModal('modalEmpresa')" style="width: 100%; background:none; color:gray; border:none; margin-top:10px;">Cancelar</button>
        </form>
    </div>
</div>

<div id="modalQR" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3 id="qr-nome"></h3>
        <div id="qrcode" style="margin: 20px auto; display: inline-block;"></div>
        <p style="font-size: 0.8rem; color: gray;">Aponte o tablet para este código para configurar a unidade.</p><br>
        <button onclick="closeModal('modalQR')" class="btn-add">Fechar</button>
    </div>
</div>

<script>
    // ⚠️ ATENÇÃO: Se estiver testando localmente, use "http://127.0.0.1:5000/api"
    // Se estiver na Vercel, use a URL da sua API
    const API_URL = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost' 
        ? "http://127.0.0.1:5000/api" 
        : "https://seu-back-no-vercel.vercel.app/api";

    async function carregarEmpresas() {
        try {
            const res = await fetch(`${API_URL}/clientes`);
            const dados = await res.json();
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = '';

            dados.forEach(emp => {
                lista.innerHTML += `
                    <tr>
                        <td><strong>${emp.nome_fantasia}</strong><br><small>${emp.cnpj}</small></td>
                        <td>${emp.plano}</td>
                        <td><span class="status-pill ${emp.status === 'ativo' ? 'status-active' : 'status-blocked'}">${emp.status}</span></td>
                        <td>
                            <button class="btn-icon" onclick="gerarQR('${emp.id}', '${emp.nome_fantasia}')" title="Configurar Tablet"><i class="fas fa-qrcode"></i></button>
                            <button class="btn-icon" onclick="baixarAFD('${emp.id}')" title="Baixar AFD"><i class="fas fa-file-download"></i></button>
                            <button class="btn-icon" onclick="excluir('${emp.id}')" style="color:red;"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        } catch (e) {
            console.error("Erro na API:", e);
            document.getElementById('lista-clientes').innerHTML = "<tr><td colspan='4'>Erro ao carregar dados da API. Verifique se o backend está rodando.</td></tr>";
        }
    }

    document.getElementById('formCliente').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            nome: document.getElementById('nome').value,
            cnpj: document.getElementById('cnpj').value,
            plano: 'basico'
        };

        const res = await fetch(`${API_URL}/clientes`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            closeModal('modalEmpresa');
            carregarEmpresas();
        }
    });

    function gerarQR(id, nome) {
        document.getElementById('qr-nome').innerText = nome;
        const qrDiv = document.getElementById('qrcode');
        qrDiv.innerHTML = '';
        // O payload deve ser o mesmo que o tablet.html espera (config_ponto_saas)
        const config = btoa(JSON.stringify({ id: id, nome: nome, api: API_URL }));
        new QRCode(qrDiv, { text: config, width: 200, height: 200 });
        openModal('modalQR');
    }

    async function baixarAFD(id) {
        window.open(`${API_URL}/clientes/${id}/afd`, '_blank');
    }

    async function excluir(id) {
        if(confirm("Deseja excluir esta empresa?")) {
            await fetch(`${API_URL}/clientes/${id}`, { method: 'DELETE' });
            carregarEmpresas();
        }
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    window.onload = carregarEmpresas;
</script>
</body>
</html>
