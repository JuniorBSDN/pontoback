<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>PontoBack | Gestão de Unidade</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #4f46e5; --sidebar-bg: #0f172a; --bg: #f8fafc; --border: #e2e8f0; --danger: #ef4444; --success: #10b981; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; color: #1e293b; }
        .sidebar { background: var(--sidebar-bg); color: white; width: 260px; height: 100vh; padding: 2rem; position: fixed; }
        .main { margin-left: 260px; padding: 3rem; width: 100%; }
        .card { background: white; border-radius: 12px; border: 1px solid var(--border); padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { background: #f1f5f9; padding: 1rem; text-align: left; font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        td { padding: 1rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .modal { display:none; position:fixed; inset:0; background:rgba(15, 23, 42, 0.7); align-items:center; justify-content:center; z-index: 1000; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background:white; padding:2rem; border-radius:16px; width:100%; max-width:500px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; }
        .login-screen { position: fixed; inset: 0; background: var(--sidebar-bg); display: flex; align-items: center; justify-content: center; z-index: 5000; }
    </style>
</head>
<body>

<div id="login-area" class="login-screen">
    <div style="background:#1e293b; padding:2.5rem; border-radius:16px; width:380px; text-align:center;">
        <h2 style="color:white;">Gestor PontoBack</h2>
        <input type="text" id="l-cnpj" placeholder="CNPJ da Unidade">
        <input type="password" id="l-senha" placeholder="Senha">
        <button class="btn" style="width:100%; justify-content: center; margin-top: 1rem;" onclick="fazerLogin()">Entrar</button>
    </div>
</div>

<nav class="sidebar">
    <h2 style="color:#818cf8; margin-bottom: 2rem;">PontoSaaS</h2>
    <div style="margin-bottom: 2rem;">
        <small style="color:#94a3b8;">Unidade:</small>
        <strong id="unidade-nome" style="display:block;">---</strong>
    </div>
    <button onclick="sair()" style="background:none; border:1px solid #334155; color:#94a3b8; width:100%; padding:10px; border-radius:8px; cursor:pointer;">Sair</button>
</nav>

<main class="main">
    <header style="display:flex; justify-content:space-between; margin-bottom:2.5rem;">
        <h1>Colaboradores</h1>
        <button class="btn" onclick="abrirModalNovo()">
            <i class="fas fa-plus"></i> Novo Funcionário
        </button>
    </header>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Funcionário</th>
                    <th>Setor</th>
                    <th>Salário</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="lista-func"></tbody>
        </table>
    </div>
</main>

<div id="modalFunc" class="modal">
    <div class="modal-content">
        <h3 id="modal-titulo">Cadastrar Funcionário</h3>
        <input type="text" id="f-nome" placeholder="Nome Completo">
        <input type="text" id="f-cpf" placeholder="CPF (apenas números)">
        <input type="text" id="f-setor" placeholder="Setor">
        <input type="number" id="f-salario" placeholder="Salário Base">
        <select id="f-tipo">
            <option value="CLT">CLT</option>
            <option value="PJ">PJ</option>
        </select>
        <button class="btn" style="width:100%; margin-top:1rem; justify-content:center;" onclick="salvarFuncionario()">Gravar</button>
        <button onclick="fecharModal()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer; color: #64748b;">Cancelar</button>
    </div>
</div>

<script>
    const API_URL = "SUA_URL_DA_API_AQUI"; // Ex: https://pontoback.vercel.app/api
    let config = JSON.parse(localStorage.getItem("config_gestor"));

    function iniciar() {
        if (config) {
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('unidade-nome').innerText = config.nome;
            carregarFuncionarios();
        }
    }

    async function fazerLogin() {
        const cnpj = document.getElementById('l-cnpj').value;
        const senha = document.getElementById('l-senha').value;
        const res = await fetch(`${API_URL}/clientes/login-tablet`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ cnpj, senha })
        });
        if (res.ok) {
            const dados = await res.json();
            config = { id: dados.id, nome: dados.nome };
            localStorage.setItem("config_gestor", JSON.stringify(config));
            location.reload();
        } else { alert("Erro no login"); }
    }

    async function carregarFuncionarios() {
        const res = await fetch(`${API_URL}/funcionarios/${config.id}`);
        const lista = await res.json();
        const corpo = document.getElementById('lista-func');
        corpo.innerHTML = lista.map(f => `
            <tr>
                <td><strong>${f.nome}</strong><br><small>${f.cpf}</small></td>
                <td>${f.setor}</td>
                <td>R$ ${f.salario_base}</td>
                <td>
                    <button class="btn" style="background:#64748b;" onclick="prepararEdicao('${f.nome}','${f.cpf}','${f.setor}',${f.salario_base},'${f.tipo_contrato}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" onclick="excluirFunc('${f.cpf}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function abrirModalNovo() {
        document.getElementById('modal-titulo').innerText = "Novo Funcionário";
        document.getElementById('f-cpf').disabled = false;
        limparCampos();
        document.getElementById('modalFunc').style.display = 'flex';
    }

    function prepararEdicao(nome, cpf, setor, salario, tipo) {
        document.getElementById('modal-titulo').innerText = "Editar Funcionário";
        document.getElementById('f-nome').value = nome;
        document.getElementById('f-cpf').value = cpf;
        document.getElementById('f-cpf').disabled = true; // CPF não muda
        document.getElementById('f-setor').value = setor;
        document.getElementById('f-salario').value = salario;
        document.getElementById('f-tipo').value = tipo;
        document.getElementById('modalFunc').style.display = 'flex';
    }

    async function salvarFuncionario() {
        const cpfInput = document.getElementById('f-cpf');
        const cpf = cpfInput.value;
        const dados = {
            nome: document.getElementById('f-nome').value,
            cpf: cpf,
            setor: document.getElementById('f-setor').value,
            salario_base: parseFloat(document.getElementById('f-salario').value),
            tipo_contrato: document.getElementById('f-tipo').value,
            cliente_id: config.id
        };

        const metodo = cpfInput.disabled ? 'PUT' : 'POST';
        const url = cpfInput.disabled ? `${API_URL}/funcionarios/${cpf}` : `${API_URL}/funcionarios`;

        await fetch(url, {
            method: metodo,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dados)
        });
        fecharModal();
        carregarFuncionarios();
    }

    async function excluirFunc(cpf) {
        if(confirm("Excluir funcionário?")) {
            await fetch(`${API_URL}/funcionarios/${cpf}`, { method: 'DELETE' });
            carregarFuncionarios();
        }
    }

    function fecharModal() { document.getElementById('modalFunc').style.display = 'none'; }
    function limparCampos() { 
        document.getElementById('f-nome').value = ""; 
        document.getElementById('f-cpf').value = ""; 
        document.getElementById('f-setor').value = "";
    }
    function sair() { localStorage.clear(); location.reload(); }
    iniciar();
</script>
</body>
</html>
