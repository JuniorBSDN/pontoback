<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Tablet PontoSaaS</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: #1e293b; padding: 30px; border-radius: 12px; width: 350px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #4f46e5; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #reader { width: 100%; margin-top: 20px; border-radius: 12px; overflow: hidden; display: none; }
    </style>
</head>
<body>

    <div id="login-area" class="card">
        <h2>PontoSaaS</h2>
        <p>Ativação da Unidade</p>
        <input type="text" id="cnpj" placeholder="CNPJ da Unidade">
        <input type="password" id="senha" placeholder="Senha de Acesso">
        <button onclick="fazerLogin()">ATIVAR TABLET</button>
        <p id="erro" style="color: #ef4444; display: none;">Dados incorretos!</p>
    </div>

    <div id="ponto-area" style="display:none; text-align:center;">
        <h1 id="nome-unidade"></h1>
        <div id="reader"></div>
        <p>Aproxime seu QR Code</p>
        <button onclick="sair()" style="background:#334155; width: auto; padding: 5px 15px;">Sair</button>
    </div>

    <script>
        const API_URL = "https://pontoback-tau.vercel.app/api";
        let config = JSON.parse(localStorage.getItem("config_tablet"));

        function iniciar() {
            if (config) { mostrarPonto(); }
        }

        async function fazerLogin() {
            const cnpj = document.getElementById('cnpj').value;
            const senha = document.getElementById('senha').value;

            const res = await fetch(`${API_URL}/clientes/login-tablet`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ cnpj, senha })
            });

            if (res.ok) {
                const dados = await res.json();
                config = { id: dados.id, nome: dados.nome };
                localStorage.setItem("config_tablet", JSON.stringify(config));
                mostrarPonto();
            } else {
                document.getElementById('erro').style.display = 'block';
            }
        }

        function mostrarPonto() {
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('ponto-area').style.display = 'block';
            document.getElementById('nome-unidade').innerText = config.nome;

            const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render((id) => {
                alert("Ponto registrado para o ID: " + id);
                // Aqui você chama a rota /api/ponto/registrar que já tem no index.py
            });
        }

        function sair() { localStorage.removeItem("config_tablet"); location.reload(); }
        iniciar();
    </script>
</body>
</html>
