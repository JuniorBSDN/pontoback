<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PontoSaaS | Terminal Tablet</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #0f172a; --card: #1e293b; --success: #22c55e; --danger: #ef4444; --info: #3b82f6; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; overflow: hidden; }
        .card { background: var(--card); padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        #reader { width: 100%; margin-top: 20px; border-radius: 12px; overflow: hidden; border: 2px solid #334155; background: #000; }
        #feedback {
            display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 20px 40px; border-radius: 12px; font-size: 1.5rem; font-weight: bold;
            z-index: 9999; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            animation: slideDown 0.5s ease-out; white-space: pre-wrap;
        }
        @keyframes slideDown { from { top: -100px; } to { top: 20px; } }
        .info-text { margin-top: 15px; color: #94a3b8; font-size: 0.9rem; }
        #nome-unidade { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div id="feedback"></div>

    <div id="login-area" class="card">
        <h2>Ativar Tablet</h2>
        <p class="info-text">Identifique a unidade para começar</p>
        <input type="text" id="t-cnpj" placeholder="CNPJ da Unidade">
        <input type="password" id="t-senha" placeholder="Senha de Acesso">
        <button onclick="ativarTablet()">Ativar Dispositivo</button>
    </div>

    <div id="ponto-area" class="card" style="display: none;">
        <h2 id="nome-unidade">Unidade...</h2>
        <p>Aponte seu QR Code para a câmera</p>
        <div id="reader"></div>
        <p class="info-text">Entrada e Saída detectadas automaticamente.</p>
        <button onclick="sair()" style="margin-top: 20px; background: #334155; padding: 8px;">Desativar Tablet</button>
    </div>

    <script>
        // URL da API (Certifique-se de que esta é a URL correta do seu backend)
        const API_URL = "https://pontoback-tau.vercel.app/api";

        let config = JSON.parse(localStorage.getItem("config_tablet"));

        // Inicia o sistema se já estiver logado
        function iniciar() {
            if (config) {
                document.getElementById('login-area').style.display = 'none';
                document.getElementById('ponto-area').style.display = 'block';
                document.getElementById('nome-unidade').innerText = config.nome;
                startScanner();
            }
        }

        async function ativarTablet() {
            const cnpj = document.getElementById('t-cnpj').value;
            const senha = document.getElementById('t-senha').value;

            try {
                const res = await fetch(`${API_URL}/clientes/login-tablet`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cnpj, senha })
                });

                if (res.ok) {
                    const dados = await res.json();
                    config = { id: dados.id, nome: dados.nome };
                    localStorage.setItem("config_tablet", JSON.stringify(config));
                    location.reload();
                } else {
                    mostrarFeedback("Acesso negado!\nVerifique os dados.", "erro");
                }
            } catch (e) {
                mostrarFeedback("ERRO DE CONEXÃO", "erro");
            }
        }

        function startScanner() {
            const scanner = new Html5QrcodeScanner("reader", {
                fps: 15, // Aumentado para leitura mais rápida
                qrbox: { width: 250, height: 250 }
            });

            scanner.render(async (cpfLido) => {
                // Previne leituras múltiplas consecutivas
                if (window.processandoPonto) return;
                window.processandoPonto = true;

                // Limpa o CPF de qualquer caractere não numérico
                const cpfLimpo = cpfLido.replace(/\D/g, "");

                try {
                    // Chamada sincronizada com a rota @app.route('/api/ponto', methods=['POST'])
                    const res = await fetch(`${API_URL}/ponto`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            cliente_id: config.id, // Sincronizado com backend
                            cpf: cpfLimpo          // Sincronizado com backend
                        })
                    });

                    const data = await res.json();

                    if (res.ok) {
                        let msg = data.tipo === "ENTRADA"
                            ? `BOM TRABALHO!\n${data.funcionario || 'Entrada Registrada'}`
                            : `ATÉ LOGO!\nSaída: ${data.horas || 0}h trabalhadas hoje`;

                        mostrarFeedback(msg, data.tipo === "ENTRADA" ? "sucesso" : "info");
                    } else {
                        mostrarFeedback(data.erro || "FALHA NO REGISTRO", "erro");
                    }
                } catch (e) {
                    mostrarFeedback("FALHA NA COMUNICAÇÃO", "erro");
                } finally {
                    // Aguarda 5 segundos para limpar o estado e permitir novo scan
                    setTimeout(() => { window.processandoPonto = false; }, 5000);
                }
            });
        }

        function mostrarFeedback(mensagem, tipo) {
            const fb = document.getElementById('feedback');
            fb.innerText = mensagem;
            fb.style.display = 'block';

            if (tipo === "sucesso") fb.style.background = "var(--success)";
            else if (tipo === "info") fb.style.background = "var(--info)";
            else fb.style.background = "var(--danger)";

            setTimeout(() => { fb.style.display = 'none'; }, 4500);
        }

        function sair() {
            if(confirm("Deseja realmente desativar este terminal?")) {
                localStorage.clear();
                location.reload();
            }
        }

        iniciar();
    </script>
</body>
</html>
