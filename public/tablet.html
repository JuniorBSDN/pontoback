<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Ponto - PontoSaaS</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #6366f1; --danger: #ef4444; --warning: #f59e0b; }
        body {
            background: #0f172a; color: white; text-align: center;
            font-family: 'Inter', sans-serif; margin: 0;
            display: flex; flex-direction: column; justify-content: center; min-height: 100vh;
        }
        #reader {
            width: 95%; max-width: 500px; margin: 10px auto;
            border-radius: 15px; overflow: hidden; border: 2px solid #334155;
            background: #1e293b;
        }
        .alert-offline {
            background: var(--warning); padding: 12px; position: fixed;
            top: 0; width: 100%; display: none; font-weight: bold; z-index: 100;
        }
        #unidade-nome { font-size: 1.8rem; margin: 0; color: var(--primary); }
        #geo-status { font-size: 0.9rem; color: #94a3b8; margin-bottom: 15px; }
        #msg { font-size: 1.1rem; color: #94a3b8; min-height: 1.5em; }

        .btn-camera-manual {
            background: var(--primary); color: white; border: none;
            padding: 15px 25px; border-radius: 8px; font-weight: bold;
            cursor: pointer; display: none; margin: 20px auto;
        }
        .btn-reset {
            background: none; border: 1px solid #334155; color: #475569;
            padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 30px;
        }
        .gps-overlay {
            display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95);
            z-index: 1000; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
    </style>
</head>
<body>
    <div id="gps-lock" class="gps-overlay">
        <h2 style="color:var(--danger)">üìç GPS Obrigat√≥rio</h2>
        <p>Para registrar o ponto, voc√™ deve permitir o acesso √† localiza√ß√£o.</p>
        <button onclick="location.reload()" style="padding:10px 20px;">Tentar Novamente</button>
    </div>

    <div id="status-offline" class="alert-offline">MODO OFFLINE - Registros salvos localmente</div>

    <h1 id="unidade-nome">Iniciando...</h1>
    <div id="geo-status">üì° Aguardando GPS...</div>

    <button id="btn-camera-trigger" class="btn-camera-manual" onclick="for√ßarCamera()">üì∏ Ativar C√¢mera</button>

    <div id="reader"></div>
    <p id="msg">Aguardando c√¢mera...</p>

    <button class="btn-reset" onclick="resetConfig()">Reconfigurar Unidade</button>

    <script>
        const STORAGE_KEY = "config_ponto_saas";
        let scanner = null;
        let localizacaoAtual = null;
        let config = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");

        async function iniciar() {
            if (!config) return modoConfig();

            document.getElementById('unidade-nome').innerText = config.nome;
            obterLocalizacaoConstante();
            tentarIniciarLeitor();

            setInterval(sincronizar, 30000); // Sincroniza offline a cada 30s
        }

        function obterLocalizacaoConstante() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    (pos) => {
                        localizacaoAtual = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        document.getElementById('geo-status').innerText = "üìç Localiza√ß√£o Fixada";
                        document.getElementById('gps-lock').style.display = 'none';
                    },
                    (err) => {
                        document.getElementById('gps-lock').style.display = 'flex';
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        function tentarIniciarLeitor() {
            document.getElementById('msg').innerText = "Iniciando c√¢mera...";

            scanner = new Html5QrcodeScanner("reader", {
                fps: 15,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            });

            scanner.render(onScanSuccess, onScanFailure);

            // Se em 4 segundos o v√≠deo n√£o aparecer, mostra o bot√£o manual
            setTimeout(() => {
                if (!document.querySelector('#reader video')) {
                    document.getElementById('btn-camera-trigger').style.display = 'block';
                    document.getElementById('msg').innerText = "Clique no bot√£o para ativar a c√¢mera";
                }
            }, 4000);
        }

        function for√ßarCamera() {
            location.reload(); // Recarregar √© a forma mais segura de pedir permiss√£o novamente
        }

        async function onScanSuccess(idFuncionario) {
            // Previne m√∫ltiplas leituras r√°pidas do mesmo c√≥digo
            scanner.pause();

            const batida = {
                id_cliente: config.id,
                id_funcionario: idFuncionario,
                timestamp_local: new Date().toISOString(),
                geo: localizacaoAtual
            };

            await enviarPonto(batida);

            setTimeout(() => scanner.resume(), 3000); // Aguarda 3s para pr√≥xima leitura
        }

        function onScanFailure(error) { /* Erros de leitura ignorados para fluidez */ }

        async function enviarPonto(batida) {
            try {
                const res = await fetch(`${config.api}/ponto/registrar`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(batida)
                });

                if (res.ok) {
                    alert("‚úÖ PONTO REGISTRADO!");
                } else {
                    throw new Error();
                }
            } catch(e) {
                salvarOffline(batida);
            }
        }

        function salvarOffline(batida) {
            let fila = JSON.parse(localStorage.getItem("fila") || "[]");
            fila.push({...batida, offline: true});
            localStorage.setItem("fila", JSON.stringify(fila));
            document.getElementById('status-offline').style.display = 'block';
            alert("‚òÅÔ∏è Registrado Offline. Sincroniza√ß√£o autom√°tica ativa.");
        }

        async function sincronizar() {
            if (!navigator.onLine || !config) return;
            let fila = JSON.parse(localStorage.getItem("fila") || "[]");
            if (fila.length === 0) return;

            for (let i = fila.length - 1; i >= 0; i--) {
                try {
                    const res = await fetch(`${config.api}/ponto/registrar`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(fila[i])
                    });
                    if (res.ok) fila.splice(i, 1);
                } catch(e) { break; }
            }
            localStorage.setItem("fila", JSON.stringify(fila));
            if (fila.length === 0) document.getElementById('status-offline').style.display = 'none';
        }

        function modoConfig() {
            document.getElementById('unidade-nome').innerText = "Configura√ß√£o";
            document.getElementById('msg').innerText = "Escaneie o QR de Ativa√ß√£o do Admin";

            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render((txt) => {
                try {
                    const configStr = atob(txt);
                    localStorage.setItem(STORAGE_KEY, configStr);
                    alert("Unidade Configurada!");
                    location.reload();
                } catch(e) { alert("C√≥digo de ativa√ß√£o inv√°lido!"); }
            });
        }

        function resetConfig() {
            if(confirm("Limpar configura√ß√µes desta unidade?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        iniciar();
    </script>
</body>
</html>
