<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablet - PontoSaaS</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; text-align: center; margin: 0; display: flex; flex-direction: column; min-height: 100vh; justify-content: center; }
        #reader { width: 90%; max-width: 500px; margin: 20px auto; border-radius: 12px; border: 2px solid #334155; overflow: hidden; }
        .btn-cam { background: #4f46e5; color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: none; margin: 10px auto; }
    </style>
</head>
<body>
    <h1 id="unidade">Iniciando...</h1>
    <p id="gps-status">游늸 Solicitando GPS...</p>
    
    <button id="btnManual" class="btn-cam" onclick="location.reload()">游닞 Ativar C칙mera Manualmente</button>
    
    <div id="reader"></div>
    <p id="msg">Aponte o QR Code do Crach치</p>

    <script>
        const KEY = "config_ponto_saas";
        let config = JSON.parse(localStorage.getItem(KEY));
        let scanner, geo = null;

        async function iniciar() {
            if (!config) return modoConfig();
            
            document.getElementById('unidade').innerText = config.nome;
            
            // Iniciar GPS
            navigator.geolocation.watchPosition(p => {
                geo = {lat: p.coords.latitude, lng: p.coords.longitude};
                document.getElementById('gps-status').innerText = "游늸 GPS Ativo";
            }, () => { alert("GPS 칠 obrigat칩rio!"); }, {enableHighAccuracy: true});

            // Iniciar C칙mera
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render(onScan);

            // Backup se a c칙mera demorar
            setTimeout(() => { if(!document.querySelector('video')) document.getElementById('btnManual').style.display='block'; }, 4000);
            
            // Sincronizador Offline
            setInterval(sincronizar, 30000);
        }

        async function onScan(idFunc) {
            scanner.pause();
            const batida = {
                id_cliente: config.id,
                id_funcionario: idFunc,
                timestamp_local: new Date().toISOString(),
                geo: geo
            };

            try {
                const res = await fetch(`${config.api}/ponto/registrar`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(batida)
                });
                if(res.ok) alert("Ponto Registrado!");
            } catch(e) {
                let fila = JSON.parse(localStorage.getItem("fila") || "[]");
                fila.push(batida);
                localStorage.setItem("fila", JSON.stringify(fila));
                alert("Offline: Guardado no dispositivo");
            }
            setTimeout(() => scanner.resume(), 3000);
        }

        function modoConfig() {
            document.getElementById('unidade').innerText = "Ativa칞칚o";
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render(txt => {
                localStorage.setItem(KEY, atob(txt));
                location.reload();
            });
        }

        async function sincronizar() {
            let fila = JSON.parse(localStorage.getItem("fila") || "[]");
            if(fila.length === 0) return;
            for(let i=fila.length-1; i>=0; i--) {
                const res = await fetch(`${config.api}/ponto/registrar`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(fila[i])
                });
                if(res.ok) fila.splice(i, 1);
            }
            localStorage.setItem("fila", JSON.stringify(fila));
        }

        iniciar();
    </script>
</body>
</html>
